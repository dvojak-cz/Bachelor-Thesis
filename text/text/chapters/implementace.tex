\chapter{Návrh řešení a implementace}
\noindent\makebox[\linewidth]{\rule{\paperwidth}{0.4pt}}
\begin{chapterabstract}
Tato kapitola popisuje návrh a implementaci řešení problému z předchozí kapitoly. Cílem této kapitoly je vytvořit modul pro systému kubernetes, který umožní jednoduchý způsob pro propojení interní sítě kubernets a privátní sítě přilehlé k klastru. Nedílnou součástí této kapitoly je ukázat způsob jakým modul vytvořit a následně uvést ukázku použití.
\end{chapterabstract}


\section{Návrh řešení}
Před implementací samotného řešení je nutné provést samotný návrh tak, aby splňoval již deklarované požadavky.

Navrhované řešení bude rozšiřovat možnosti kubernetes o nový druh síťování, mezi virtuální sítí kubernetes a přilehlým privátním síťovým segmentem. \textbf{Bude pouzit jeden smer a proxy}  
\section{Rozšiřování kubernetes}
Kubernets je velmi dobře navržen proto, aby byl jednoduše rozšiřitelný. Na oficiálních stránkách projektu Kubernets je uvedeno: 
\begin{displayquote}
Kubernetes is highly configurable and extensible. As a result, there is rarely a need to fork or submit patches to the Kubernetes project code.
\end{displayquote}
\noindent\rule{2cm}{0.4pt}
\begin{displayquote}
Kubernetes je vysoce konfigurovatelný a rozšiřitelný. Díky tomu je jen zřídka potřeba kód projektu Kubernetes forkovat nebo zasílat záplaty.
\end{displayquote}
\cite{thekubernetesauthors_2022_network}\footnote{deepl}

V případě potřeby, kubernetes nabízí způsoby, kterým lze systém rozšířit. Dokumentace projektu popisuje různé potřeby pro rozšíření systému a zároveň odkazuje na způsoby, jak toho dosáhnout. Pro účely této práce je důležitá sekce popisující rozšiřování kubernetes API, automatizace práce a rozšíření síťování.\textbf{CITOVAT}

\section{Rozšíření síťování - CNI}
Pro potřeby rozšíření síťování kubernetes doporučuje tvorbu vlastního CNI modulu dle CNI specifikace. Tento způsob dává dobrý smysl. Tvorbou vlastního CNI modulu lze plně kontrolovat síťování v Kuberneets. To přináší velkou svobodu a možnost přizpůsobení konkrétním potřebám.

Při vývoji vlastního CNI pluginů je nutné plnit všechny požadavky stanovené specifikací a zároveň plnit požadavky, které jsou popsány na stránkách kubernetes. Většina implementací se skládá z CNI konfiguračního souboru, binárního spustitelného souboru a běžící aplikace v systému kubernets. Pro správné fungování CNI pluginu je nutné zajistit následující. Daná specifikace se musí nachází na každém pracovním uzlu v adresáři \verb|pod.spec.hostNetwork|. Adresář s CNI pluginy (typicky \verb|/opt/cni/bin|) musí obsahovat potřebný spustitelný soubor specifikovaný v konfiguračním souboru. Na každém pracovním uzlu musí běžet aplikace, která pomáhá se síťování v klastru. Těchto podmínek lze jednoduše docílit pomocí standartních objektů kubernets. \cite{bigelow_2022_explore}\\

\subsection{Zvolení potřebného delegujícího CNI pluginu}
V kapitole o možných řešení je řešení pomoci proxy uvedeno, jako vyhovující a \textit{nejlepší možné}. Zároveň tato kapitola uvádí, že pro potřeby použití proxy je nutné umožnit tvorbu podu s více rozhraními - tomuto přesně vyhovuje standart \textit{Kubernetes Network Custom Resource Definition De-facto Standard}.

Tento standard umožňuje implementaci několik různých tzv. gelegujících pluginů. Všechny tyto pluginy odpovídají standardu \textit{Kubernetes Network Custom Resource Definition De-facto Standard} a zajišťují možnost tvorby podu s více síťovými rozhraními. Tento standard je například implementován jako součást CNI pluginu Contrail, nebo například delegujícím pluginem multus CNI.

Contrail splňuje specifikaci CNI i Kubernetes Network Custom Resource Definition. Tento plugin splňuje potřeby pro řešení problému, jedná se ale o velký pokročilý plugin, který je těžké nastavovat a spravovat. Zároveň jeho použití může omezit některé specifické potřeby archytektur klaudu.

Druhý zmíněný projekt, který splňuje danou specifikaci je MultusCNI. Multus CNI je gelegujících pluginů, který je vyvíjen přímo skupinou Network Plumbing Working Group, která vytvořila zmíněný standard. MultusCNI není přímo CNI plugin jako Contrail. Tento projekt je označován jako meta-plugin. \footnote{https://github.com/k8snetworkplumbingwg/multus-cni} Multus CNI byl navržen jako zásuvný modul, který rozšiřuje základní Kubernetes CNI o funkce pro více rozhraní. Multus CNI používá koncept "hlavního" CNI zásuvného modulu a "delegovaných" CNI zásuvných modulů. Hlavní CNI zásuvný modul je zodpovědný za správu životního cyklu Multus a deleguje konfiguraci a přidělení síťových rozhraní na další CNI zásuvné moduly. Tímto způsobem Multus CNI funguje jako takový orchestrátor pro ostatní CNI zásuvné moduly, umožňujíc současnou práci s více různými sítěmi. Toto chování je umožněno především tím, že specifikace CNI možnost delegace práce mezi pluginy. Toto je popsáno zmíněno v první kapitole v sekci popisující standard \ref{cni}. Pro zjedudušení by se dalo říct, že při vzniku podu multus vždy volá "hlavního" CNI a pokud pod definuje, tak i všechny delegované moduly. Tento způsob umožňuje tvorbu podů s více síťovími rozhraními. Zároveň se jedná o velmi elegantní řešení, jelikož poskytuje velkou volnost použití a nijak neomezuje standartní síťování. Multus je velmi dobrou volbou pro řešení problému. Právě tento meta-plugin je použit v ukázce přešení. Konrétní použití je uvedeno v sekci \ref{prostredi}

\section{Rozšiřování kubernetes API - CRD}
Velká část systému kubernetes se skládá z definic objektů. Kubernetes objekty jsou prvky, které uchovávají stav klastru, lze si je představit jako datové struktury nesoucí informace. Tyto objekty slouží i pro komunikaci s kubernetes API serverem. API server poskytuje základní CRUD operace k těmto objektům, díky těmto operacím lze konfigurovat, nastavovat a ovládat samotný klaud.

Kubernetes poskytuje základní objekty pro práci s klastrem. Příklady těchto objektů jsou Pod, Deployment, Endpoint, Namespace... Tyto objekty jsou navrženy a spravovány autory kubernetes. Jedním ze standartích objektů je i CustomResourceDefinition. CustomResourceDefinition (zkráceně CRD) je meta-objekt, který umožňuje definovat vlastní nové objekty. CRD pak umožňuje definovat strukturu nových objektů (datových struktur). Příkladem použití CRD je již zmíněný Network Attachment Definition, který byl definovaný v dokumentu Kubernetes Network Custom Resource Definition De-facto Standard. V případě, že je nový CRD objekt vytvořen, je tento objekt přidán do kubernetes API a tím je možné s ním kubernetes pracovat. Pro nový datový objekt jsou automaticky vytvořeny základní CRUD operace.

CustomResourceDefinition poskytuje velmi elegantní způsob a jakým lze rozšiřovat kubernetes API o nové objekty.  
\subsection{Návrh vlastních CRD objektů}
Jedním z požadavků zmíněných v sekci \ref{sec:pozadavky} je Jednoduchost. Pro jednoduchost je požadováno, aby řešení podporovalo zavedené způsoby komunikace s klastrem. Toho lze velmi dobře dosáhnout právě za použití CRD. Navržením nových objektů rozšíří standartní API kubernetes dobře rozšířit API kubernetes. S nově vzniklými objekty lze následně pracovat pomocí operátorů (popáno v další sekci). Tento způsob zároveň přináší řadu výhod a usnadnění. Jelikož se o správu objektů stará přímo kubernetes, můžeme se spolehnout na persistenci dat, která vychází z vlastností databáze etcd, tato databáze bude řešit i kolize, které mohou vzniknout při souběžném přístupu k datům. Další výhoud je, že tyto objekty budou dokumentovány standartním způsobem kuebrneets. O jejich validaci se z velké části bude starat kubernetes API server. Jelikož tento způsob nabízí celou řadu výhod a zároveň splňuje požadavek pro jednoduchost, je vhodným pro účely řešení problému.

Nyní se zaměříme pouze na návrh CRD objektů pro účely řešení problému. Tyto objekty budou tvořit kompletní API pro ovládání tvořeného rozšíření kubernetes.

Navrhované API bude obsahovat tři CRD objkty. Prvním objektem bude \textit{Network Attachment Definition}. \textit{Network Attachment Definition} je deinován v standardu \textit{Kubernetes Network Custom Resource Definition De-
facto Standard} popsaném v sekci \ref{sec:kncrdds}. Pro více informací o tomto objektu doporučuji si přečíst samotnous specifikaci. Dálšími dvěma objety budou Device a Connection. Oba objekty jsou součástí API skupiny \textit{edge-operator.k8s.dvojak.cz}.  
\subsubsection{Device}
Prvním z objektu rozšiřující standartní API je \textit{device}. Objekt device reprezentuje zařízení, která se nachází v privátní síti, mimo klastr. Toto zařízení by mělo být dostupné přes jeden či více z uzlů v clusteru, tyto uzly pak souží jako brány k zařízení. Ve schémau \ref{fig:schema} z přechozí kapitoly by zařízení byly použity pro uchování informací o \textit{device01-01} a \textit{device01-02}. Objekt složí primárně pro ukládání informací o zařízeních. Ve výpisu kódu \ref{sample:device} lze vidět ukázkovou definici objktu.
\input{text/code/sample_device}
Device uchovává 
\begin{description}
    \item \verb|.spec.nodeName| --- Název pracovního uzlu, který je připojen do privátní sítě a sítě kuberetes. Tento uzel bude použit pro vytvoření mostu a provozování proxy.
    \item \verb|.spec.up| --- Definuje, zda je dané zařízení zapnuté a může být použito.
    \item \verb|.spec.ipAddress| --- IP adresa zařízení v privátní síti.
    \item \verb|.spec.components| --- Seznam komponent, které na zařízení běží a jsou dostupné po síti. Komponenta označuje běžící aplikaci. Příkladem takové komponenty může být webový server či jiná aplikace.  
    \item \verb|.spec.components.name| --- Název komponenty pro identifikaci.
    \item \verb|.spec.components.up| --- Určuje, zda je daná komponenta zapnuté a může být použita.
    \item \verb|.spec.components.handlers| --- Seznam portů, které daná aplikace obsahuje.
    \item \verb|.spec.components.handlers.name| --- Název portu. Tento parametr nemá přímé použití, slouží pouze pro dokumentační účely. 
    \item \verb|.spec.components.handlers.protocol| --- Protokol značuje typ použitého protokolu, povolené hodnoty jsou TCP, UDP a HTTP
    \item \verb|.spec.components.handlers.port| --- Číslo daného portu
    \item \verb|.spec.components.handlers.endpoints| --- Seznam koncových bodů (endpointů). Tento seznam je nepovinný a slouží pouze pro dokumentační účely.
\end{description}

Od této chvíle budeme zařízení v privání síti značit jako \textit{Device}.

\subsubsection{Connection}
Druhým deinovaným CRD objektem je \textit{Connection}. \textit{Connection} reprezentuje již vytvořené spojení se zařízením v privátní síti \textit{Device}. Objekt složí primárně pro uchovávání informací o spojení a zároveň k ovládání daného rozšíření. Infomace o ovládání bude popsána v sekci \ref{sec:operator} o operátoru. Struktura objektu je nastíněna v ukázce kódu \ref{sample:connection}.


Connection represents a connection between a device and kubernetes cluster. By creating a connection, service will be created for abstracting device connection. By sending data to that service, data will be sent to device.


\input{text/code/sample_connection}

\begin{description}
    \item \verb|.spec.deviceName| --- Název objektu \textit{device}, ke ketrému bude vytvořeno spojení proxy. 
    \item \verb|.spec.networkName| --- Návez \textit{NetworkAttachmentDefinition}. Tento objekt definuje nasatveeí sítě v podu, které bude použito pro pod s proxy.
    \item \verb|.spec.componentNames| --- Seznam komponent objektu \textit{device}, ke ketrému bude vytvořeno spojení proxy. 
\end{description}
\footnote{ten clanek kter citoval hezkej pan}
\section{Automatizace práce - Operátor}\label{sec:operator}
Objekty slouží jako datové struktury pro ukládaní informací o stavu klatru. Tyto objekty jsou zpracovávány pomocí kubernetes kontrolerů. Kontroler jsou nekonečné smyčky, které mají za úkol udržovat klastru v požadovaném stavu, který je definovaný objekty. Kontrolery lze chápat jako pracovníky, kteří spravují celý systém kubernetes. Oficiální dokumentace uvádí příklad na termostatu. Termostat je typicky nastaven na fixní požadovanou teplotu, kterou má za úkol v místnosti udržet. V případě, že teplota klesne pod požadovanou hladinu, pak provede potřebné kroky pro zvýšení teploty v místnosti na požadovanou teplotu. Stejným způsobem fungují kontrolery v systému kuberneets. Neustále porovnávají aktuální stav klatrtu se stavem požadovaným (definovaným objekty). V případě že se tyto dva stavy liší, pak se pokusí aktuální stav klastru co nejvíce přiblížit stavu požadovanému. Tyto kontrolery jsou najčastěji provozovány formou malých aplikací.

Funkce kontroleru je pěkně ilustrována na následujícím příkladu zdrojového kódu.\cite{nguyen_2017_a}
\input{text/code/sample_controller}

Stejně jako kubernetes nabízí základní skupinu standardních objektů, tak nabízí i standardní množinu kontrolerů pracující se standardními objekty. Tyto kontrolery jsou spravovány vývojáři kubernetes a jsou součástí základní instalace systému. Příkladem těchto kontrolerů jsou Deployment Controller, Endpoint Controller, Namespace controler\ldots Zmíněný výčet je velmi podobný výčtu objektů v předchozí kapitole. Je tomu tak, jelikož zmíněné kontrolery implementují logiku pro práci právě s danými objekty.

V předchozí částí byl zmíněn způsob rozšiřování kuberneets API pomocí CRD. Právě s CRD úzce souvisí návrhovým vzor operátor. Operátor je návrhový vzor definovaný kubernetes, který umožňuje vytvářet moduly podobné kontrolerům. Primární účel návrhového vzoru je poskytnout způsob, jakým jednoduše vyvíjet rozšíření pro systém kubernetes. Tato rozšíření často poskytují automatizaci procesů a správu aplikací běžících k kubernetes. Operátor (modul splňující návrhový vzor) je velmi často používán pro spravování CRD objektů. Příkladem operátoru může být ArgoCD operátor, který automatizuje konfiguraci klastru z gitových repozitářů.


\footnote{soc, kaplan -- insatll-fest -- argoCD, hezkej pan}\cite{velichko_2021_exploring}

\textbf{Jak funguje operator?}

Návrhový vzor operátor poskytuje dobrý způsob jakým rozšiřovat samotné fungování kubernetes.
\subsection{Implementace}
\section{Ukázka}



\begin{verbatim}
TODO
popsat API
- device
- connection

operator
- pospat proxy
  - CNI
  - AND
  - socat
  - TCP, UDP, HTTP
- deployment
- service
- validace

archytektura
- 
\end{verbatim}